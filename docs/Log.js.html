

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: Log.js | Source: Log.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="width: 0px; height: 0px">
        <img src="img/toast-ui.png" width="100%" height="100%">
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">Source: Log.js</a></h1>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
    <div class="lnb-api hidden"><h3>Modules</h3><ul><li><a href="module-@crabel_shared_csv.html">@crabel/shared/csv</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:@crabel/shared/csv_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-@crabel_shared_csv.html#~csvToArray">csvToArray</a></li></ul></div></li><li><a href="module-@crabel_shared_file.html">@crabel/shared/file</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:@crabel/shared/file_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-@crabel_shared_file.html#.addExt">addExt</a></li><li><a href="module-@crabel_shared_file.html#.copy">copy</a></li><li><a href="module-@crabel_shared_file.html#.ensurePath">ensurePath</a></li><li><a href="module-@crabel_shared_file.html#.erase">erase</a></li><li><a href="module-@crabel_shared_file.html#.loadText">loadText</a></li><li><a href="module-@crabel_shared_file.html#.makeUnique">makeUnique</a></li><li><a href="module-@crabel_shared_file.html#.move">move</a></li><li><a href="module-@crabel_shared_file.html#.removeExt">removeExt</a></li><li><a href="module-@crabel_shared_file.html#.saveText">saveText</a></li><li><a href="module-@crabel_shared_file.html#.swapExt">swapExt</a></li></ul></div></li><li><a href="module-@crabel_shared_Log.html">@crabel/shared/Log</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:@crabel/shared/Log_sub"><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-@crabel_shared_Log.html#~Column">Column</a></li><li><a href="module-@crabel_shared_Log.html#~Event">Event</a></li><li><a href="module-@crabel_shared_Log.html#~LogCallback">LogCallback</a></li><li><a href="module-@crabel_shared_Log.html#~LogOptions">LogOptions</a></li><li><a href="module-@crabel_shared_Log.html#~Table">Table</a></li></ul></div></li><li><a href="module-@crabel_shared_proto.html">@crabel/shared/proto</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:@crabel/shared/proto_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-@crabel_shared_proto.html#.init">init</a></li></ul></div></li><li><a href="module-@crabel_shared_range.html">@crabel/shared/range</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:@crabel/shared/range_sub"></div></li><li><a href="module-@crabel_shared_str_util.html">@crabel/shared/str_util</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:@crabel/shared/str_util_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-@crabel_shared_str_util.html#.align">align</a></li><li><a href="module-@crabel_shared_str_util.html#.alignC">alignC</a></li><li><a href="module-@crabel_shared_str_util.html#.alignL">alignL</a></li><li><a href="module-@crabel_shared_str_util.html#.alignR">alignR</a></li><li><a href="module-@crabel_shared_str_util.html#.buildTable">buildTable</a></li><li><a href="module-@crabel_shared_str_util.html#.capitalize">capitalize</a></li><li><a href="module-@crabel_shared_str_util.html#.crc32">crc32</a></li><li><a href="module-@crabel_shared_str_util.html#.expand">expand</a></li><li><a href="module-@crabel_shared_str_util.html#.fill">fill</a></li><li><a href="module-@crabel_shared_str_util.html#.format">format</a></li><li><a href="module-@crabel_shared_str_util.html#.formatError">formatError</a></li><li><a href="module-@crabel_shared_str_util.html#.substDate">substDate</a></li><li><a href="module-@crabel_shared_str_util.html#.substEnv">substEnv</a></li><li><a href="module-@crabel_shared_str_util.html#.substProp">substProp</a></li><li><a href="module-@crabel_shared_str_util.html#.toObject">toObject</a></li></ul><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-@crabel_shared_str_util.html#~FormatterCallback">FormatterCallback</a></li><li><a href="module-@crabel_shared_str_util.html#~ReviverCallback">ReviverCallback</a></li><li><a href="module-@crabel_shared_str_util.html#~SubstCallback">SubstCallback</a></li><li><a href="module-@crabel_shared_str_util.html#~TableColumn">TableColumn</a></li><li><a href="module-@crabel_shared_str_util.html#~TableSpecs">TableSpecs</a></li><li><a href="module-@crabel_shared_str_util.html#~Token">Token</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="Array.html">Array</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Array_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Array.html#empty">empty</a></li><li><a href="Array.html#first">first</a></li><li><a href="Array.html#isLast">isLast</a></li><li><a href="Array.html#last">last</a></li></ul></div></li><li><a href="Date.html">Date</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Date_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Date.html#.format">format</a></li><li><a href="Date.html#.formatLength">formatLength</a></li><li><a href="Date.html#.sameDay">sameDay</a></li><li><a href="Date.html#addDays">addDays</a></li><li><a href="Date.html#addHours">addHours</a></li><li><a href="Date.html#addMillis">addMillis</a></li><li><a href="Date.html#addMinutes">addMinutes</a></li><li><a href="Date.html#addMonths">addMonths</a></li><li><a href="Date.html#addSeconds">addSeconds</a></li><li><a href="Date.html#addYears">addYears</a></li><li><a href="Date.html#diff">diff</a></li><li><a href="Date.html#earlierDayThan">earlierDayThan</a></li><li><a href="Date.html#format">format</a></li><li><a href="Date.html#incDay">incDay</a></li><li><a href="Date.html#incHour">incHour</a></li><li><a href="Date.html#incMilli">incMilli</a></li><li><a href="Date.html#incMinute">incMinute</a></li><li><a href="Date.html#incMonth">incMonth</a></li><li><a href="Date.html#incSecond">incSecond</a></li><li><a href="Date.html#incYear">incYear</a></li><li><a href="Date.html#laterDayThan">laterDayThan</a></li><li><a href="Date.html#sameDay">sameDay</a></li><li><a href="Date.html#toUtc">toUtc</a></li><li><a href="Date.html#truncTime">truncTime</a></li></ul></div></li><li><a href="module-@crabel_shared_csv-CsvReader.html">CsvReader</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:@crabel/shared/csv~CsvReader_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-@crabel_shared_csv-CsvReader.html#doc">doc</a></li><li><a href="module-@crabel_shared_csv-CsvReader.html#headers">headers</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-@crabel_shared_csv-CsvReader.html#toString">toString</a></li></ul></div></li><li><a href="module-@crabel_shared_Log-Log.html">Log</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:@crabel/shared/Log~Log_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-@crabel_shared_Log-Log.html#.defEcho">defEcho</a></li><li><a href="module-@crabel_shared_Log-Log.html#.defHeader">defHeader</a></li><li><a href="module-@crabel_shared_Log-Log.html#.defLineWidth">defLineWidth</a></li><li><a href="module-@crabel_shared_Log-Log.html#.defMode">defMode</a></li><li><a href="module-@crabel_shared_Log-Log.html#.defTimeFormat">defTimeFormat</a></li><li><a href="module-@crabel_shared_Log-Log.html#.defTypeLabels">defTypeLabels</a></li><li><a href="module-@crabel_shared_Log-Log.html#.eventType">eventType</a></li><li><a href="module-@crabel_shared_Log-Log.html#.mode">mode</a></li><li><a href="module-@crabel_shared_Log-Log.html#active">active</a></li><li><a href="module-@crabel_shared_Log-Log.html#caption">caption</a></li><li><a href="module-@crabel_shared_Log-Log.html#echo">echo</a></li><li><a href="module-@crabel_shared_Log-Log.html#file">file</a></li><li><a href="module-@crabel_shared_Log-Log.html#fileName">fileName</a></li><li><a href="module-@crabel_shared_Log-Log.html#level">level</a></li><li><a href="module-@crabel_shared_Log-Log.html#lineWidth">lineWidth</a></li><li><a href="module-@crabel_shared_Log-Log.html#mode">mode</a></li><li><a href="module-@crabel_shared_Log-Log.html#name">name</a></li><li><a href="module-@crabel_shared_Log-Log.html#path">path</a></li><li><a href="module-@crabel_shared_Log-Log.html#pendingEvents">pendingEvents</a></li><li><a href="module-@crabel_shared_Log-Log.html#timeFormat">timeFormat</a></li><li><a href="module-@crabel_shared_Log-Log.html#typeLabels">typeLabels</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-@crabel_shared_Log-Log.html#.err">err</a></li><li><a href="module-@crabel_shared_Log-Log.html#.eventTypeFromStr">eventTypeFromStr</a></li><li><a href="module-@crabel_shared_Log-Log.html#.getEvntTypeStr">getEvntTypeStr</a></li><li><a href="module-@crabel_shared_Log-Log.html#.getModeStr">getModeStr</a></li><li><a href="module-@crabel_shared_Log-Log.html#.info">info</a></li><li><a href="module-@crabel_shared_Log-Log.html#.levelFromStr">levelFromStr</a></li><li><a href="module-@crabel_shared_Log-Log.html#.makeLogFileName">makeLogFileName</a></li><li><a href="module-@crabel_shared_Log-Log.html#.modeFromStr">modeFromStr</a></li><li><a href="module-@crabel_shared_Log-Log.html#.out">out</a></li><li><a href="module-@crabel_shared_Log-Log.html#.setGlobal">setGlobal</a></li><li><a href="module-@crabel_shared_Log-Log.html#.trace">trace</a></li><li><a href="module-@crabel_shared_Log-Log.html#.warn">warn</a></li><li><a href="module-@crabel_shared_Log-Log.html#applySubst">applySubst</a></li><li><a href="module-@crabel_shared_Log-Log.html#err">err</a></li><li><a href="module-@crabel_shared_Log-Log.html#info">info</a></li><li><a href="module-@crabel_shared_Log-Log.html#out">out</a></li><li><a href="module-@crabel_shared_Log-Log.html#shutdown">shutdown</a></li><li><a href="module-@crabel_shared_Log-Log.html#trace">trace</a></li><li><a href="module-@crabel_shared_Log-Log.html#warn">warn</a></li></ul></div></li><li><a href="module-@crabel_shared_range-ArrayRange.html">ArrayRange</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:@crabel/shared/range~ArrayRange_sub"></div></li><li><a href="module-@crabel_shared_range-Range.html">Range</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:@crabel/shared/range~Range_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-@crabel_shared_range-Range.html#add">add</a></li><li><a href="module-@crabel_shared_range-Range.html#clear">clear</a></li><li><a href="module-@crabel_shared_range-Range.html#combine">combine</a></li><li><a href="module-@crabel_shared_range-Range.html#empty">empty</a></li><li><a href="module-@crabel_shared_range-Range.html#exclude">exclude</a></li><li><a href="module-@crabel_shared_range-Range.html#forEach">forEach</a></li><li><a href="module-@crabel_shared_range-Range.html#from">from</a></li><li><a href="module-@crabel_shared_range-Range.html#inRange">inRange</a></li><li><a href="module-@crabel_shared_range-Range.html#intervalFromArray">intervalFromArray</a></li><li><a href="module-@crabel_shared_range-Range.html#same">same</a></li><li><a href="module-@crabel_shared_range-Range.html#subtract">subtract</a></li><li><a href="module-@crabel_shared_range-Range.html#to">to</a></li><li><a href="module-@crabel_shared_range-Range.html#toString">toString</a></li><li><a href="module-@crabel_shared_range-Range.html#validInterval">validInterval</a></li></ul></div></li><li><a href="Number.html">Number</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Number_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Number.html#between">between</a></li><li><a href="Number.html#nextPow2">nextPow2</a></li><li><a href="Number.html#prevPow2">prevPow2</a></li><li><a href="Number.html#roundToInt">roundToInt</a></li><li><a href="Number.html#toEnum">toEnum</a></li><li><a href="Number.html#toTime">toTime</a></li><li><a href="Number.html#truncToInt">truncToInt</a></li><li><a href="Number.html#zeroPadd">zeroPadd</a></li></ul></div></li><li><a href="Object.html">Object</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Object_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Object.html#.className">className</a></li><li><a href="Object.html#.contains">contains</a></li><li><a href="Object.html#.copy">copy</a></li><li><a href="Object.html#.isPrimitive">isPrimitive</a></li><li><a href="Object.html#.isType">isType</a></li><li><a href="Object.html#className">className</a></li><li><a href="Object.html#clone">clone</a></li><li><a href="Object.html#contains">contains</a></li><li><a href="Object.html#is">is</a></li><li><a href="Object.html#isPrimitive">isPrimitive</a></li><li><a href="Object.html#merge">merge</a></li></ul></div></li><li><a href="StringList.html">StringList</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="StringList_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="StringList.html#clear">clear</a></li><li><a href="StringList.html#count">count</a></li><li><a href="StringList.html#empty">empty</a></li><li><a href="StringList.html#forEach">forEach</a></li><li><a href="StringList.html#line">line</a></li><li><a href="StringList.html#load">load</a></li><li><a href="StringList.html#merge">merge</a></li><li><a href="StringList.html#newLine">newLine</a></li><li><a href="StringList.html#remove">remove</a></li><li><a href="StringList.html#save">save</a></li><li><a href="StringList.html#toString">toString</a></li><li><a href="StringList.html#write">write</a></li><li><a href="StringList.html#writeLine">writeLine</a></li></ul></div></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * This module is part of the TwinTools core library. The 'Log' module exports a class
 * that encapsulates the usage and management of log files. The &lt;b>Log&lt;/b> class can be
 * used directly to access the global log object, this object must first be defined via
 * the &lt;b>setGlobal&lt;/b> function, then it can be used by any other source file directly
 * after requiring the module.&lt;br>&lt;br>
 *
 * The &lt;b>Log&lt;/b> class supports 3 modes for log file management, these are:
 *  &lt;ul>
 *      &lt;li>
 *          &lt;u>Append (Log.mode.append)&lt;/u>: New log messages are appended to an existing
 *          log file.
 *      &lt;/li>
 *      &lt;li>
 *          &lt;u>Replace (Log.mode.replace)&lt;/u>: Existing log files are overwritten.
 *      &lt;/li>
 *      &lt;li>
 *          &lt;u>Unique (Log.mode.unique)&lt;/u>: A unique name is synthesized by appending a
 *          two digit number.
 *      &lt;/li>
 *      &lt;li>
 *          &lt;u>Unique-Pre (Log.mode.unique_pre)&lt;/u>: A unique name is synthesized by
 *          pre-pending a two digit number.
 *      &lt;/li>
 *  &lt;/ul>
 *
 * The &lt;b>Log&lt;/b> class supports several types for messages including: text, err, war,
 * info and trace. These message types form a hierarchy of visibility controlled by the
 * 'Log.level' property. Messages can be logged using one of the built-in function
 * 'Log.out', 'Log.err', 'Log.warn', 'Log.info' and 'Log.trace', if the 'Log.level'
 * property is set to 'eventType.info' (the default), 'eventType.trace' messages are
 * excluded from the log file or console.
 *
 * @module @crabel/shared/Log
 * @author: Carlos Galavis &lt;carlos@galavis.net>
*/

"use strict";

const fs = require("fs");
const path = require("path");
const os = require("os");
const EventEmitter = require('events');
const util = require('util');
//
require("./proto.js");
let str_util = require("./str_util");
let file = require("./file");
let wrap = require("word-wrap");

let global_log = null;


/**
 * @typedef {Object} Column
 * @property {Number|String} width
 * @property {String} align
 */

/**
 * @typedef {Object} Table
 * @property {Array.&lt;TableColumn>} [columns]
 * @property {Array.&lt;String|Array.&lt;String>>} rows
 */

/**
 * @typedef {Object} LogOptions
 * 
 * @property {String} [caption] 
 * Optional caption used when echoing log messages.
 * 
 * @property {String} [path] 
 * (def=__dirname) Path were log files are stored.
 * 
 * @property {String} [name] 
 * (def=baseName(__filename)) Base name of the log file, the '.log' extension is appended 
 * as well as a two digit index is mode is 'unique'.
 * 
 * @property {Log.mode} [mode] 
 * (def=Log.defMode) Can be 'append', 'replace', 'unique' or 'unique_pre'.
 * 
 * @property {Boolean} [echo] 
 * (def=true) If true, logged messages are echoed to the console.
 * 
 * @property {Log.eventType} [level] 
 * (def=Log.eventType.info) Logging level. Events with higher precedence are ignored 
 * (not logged).
 * 
 * @property {String} [timeFormat] 
 * (def=defTimeFormat) Format string use to convert event timestamps to string.
 * 
 * @property {Object} [typeLabels] 
 * (def=defTypeLabels) Labels use to identify the type of event logged.
 * 
 * @property {Table|Array.&lt;String>|String} [header] 
 * (def=defHeader) Header added to the log when the log object is created.
 * 
 * @property {Number} [lineWidth] 
 * (def=90) Maximum line width.
 * 
 * @property {String} [lineStyle] 
 * (def="none") Style use to format lines of an event message, possible values are:
 * ["wrap", "trunc", "none"].
 */

/**
 * @typedef {Object} Event
 * @property {Date} timestamp
 * @property {Number} type
 * @property {String} message
 * @property {Boolean} ignored
 */

/**
 * @callback LogCallback
 * @param {Error|null} err
 * @param {Event} [event] Original event
 * @param {String} [fmsg] Formatter message.
 */

/**
 * Creates a &lt;b>Log&lt;/b> object to handle logging to a file and/or the standard output
 * stream.
 * @param {LogOptions} options
 * @param {Object] [subst_obj] Any Object used for string substitution.
 * stream.
 * @constructor
 */
function Log(options, subst_obj)
{
    if (!options.path)
        options.path = __dirname;

    if (!options.name)
        options.name = file.getBaseName(__filename);

    let self = this;
    if (undefined === options.mode)
        options.mode = Log.defMode;
    if (isNaN(options.mode))
        options.mode = Log.modeFromStr(options.mode);

    if (undefined === options.echo)
        options.echo = Log.defEcho;

    if (undefined === options.level)
        options.level = Log.eventType.info;
    if (isNaN(options.level))
        options.level = Log.levelFromStr(options.level);

    if (!options.timeFormat)
        options.timeFormat = Log.defTimeFormat;

    if (!options.typeLabels)
        options.typeLabels = Log.defTypeLabels;

    if (undefined === options.header)
        options.header = Log.defHeader.clone(true);
    
    if (!options.lineStyle)
        options.lineStyle = "none";

    if (Object.isType(subst_obj, Object))
        this.substObj = subst_obj;
    else
        this.substObj = null;

    if (Log.mode.append > options.mode || Log.mode.unique_pre &lt; options.mode)
        throw new Error("Invalid call to 'Log' contructore, the mode is invalid. Use " +
            "one of the values in 'Log.mode'.");

    /**
     * Caption used to identify log entries when echoing to the console.
     * @type {String}
     */
    this.caption = options.caption;
    
    /**
     * Path where the logfile is to be created.
     * @type {String}
     */
    this.path = options.path;

    /**
     * Name of the log file. Does not need to include the '.log' extension, this will be
     * added when constructing the file name.
     * @type {String}
     */
    this.name = options.name;

    /**
     * Indicates whether logged messages are echoed to the standard output stream.
     * @type {Boolean}
     * @default false
     */
    this.echo = options.echo || false;

    /**
     * Log file mode. Indicates whether to append, replace or create a unique log file.
     * @type {Log.mode}
     * @default Log.mode.append
     */
    this.mode = options.mode;

    /**
     * Logging level. Any messages with event type greater than &lt;b>level&lt;/b> are not
     * logged.
     * @type {Log.eventType}
     */
    this.level = options.level;

    /**
     * Format of the timestamp added to log messages. For information on the format used
     * see the Date.format documentation.
     * @type {string}
     * @default YYYYMMDD hh:mm:ss
     */
    this.timeFormat = options.timeFormat;

    /**
     * Levels use to identify the event type
     * @type {{err: string, warn: string, info: string, trace: string}}
     * @default { err: "ERR", warn: "WAR", info: "INF", trace: "TRC" }
     */
    this.typeLabels = options.typeLabels;

    /**
     * Maximum number of characters per line.
     * @type {Number}
     */
    this.lineWidth = options.lineWidth || Log.defLineWidth;

    if ("wrap" === options.lineStyle)
        this.formatLine = function (text, indent) {
            // Here '==' is used instead of '===' purposely to make the call more robust
            if (isNaN(indent) || 0 == indent)
                return wrap(text, { width: self.lineWidth });
            
            let indent_str = str_util.fill(Number(indent));

            /**
             * @type {String}
             */
            let line = wrap(text, { width: self.lineWidth - indent, indent: indent_str });
            return line.substring(indent);
        };
    else if ("trunc" === options.lineStyle)
        this.formatLine = function (text) {
            return text.substring(0, self.lineWidth);
        };
    else
        this.formatLine = function (text) {
            return text;
        };
    
    /**
     * Absolute path of the log file.
     * @type {string}
     */
    this.fileName = Log.makeLogFileName(this.path, this.name, this.mode);

    if (Log.mode.replace == this.mode)
        if (file.exists(this.fileName))
            file.erase(this.fileName);

    let file_options = {
        flags: 'w',
        defaultEncoding: 'utf8',
        autoClose: true
    };

    if (Log.mode.append == this.mode)
        file_options.flags = "a";

    /**
     * Don't use this object directly, it is used by the logging API to interact with the
     * log file.
     * @type {WriteStream}
     */
    this.file = fs.createWriteStream(this.fileName, file_options);
    if (file.exists(this.fileName)) {
        let stats = fs.statSync(this.fileName);
        if(0 &lt; stats["size"])
            this.file.write(os.EOL);
    }

    /**
     * Number of events pending to be processed. 
     * WARNING: This property is for internal use only, it can be read but should not be
     * modified or the event system will get out of sync.
     * @type {Number}
     */
    this.pendingEvents = 0;

    /**
     * Indicates whether the
     * @type {Boolean}
     */
    this.active = true;
    
    this.file.on("finish", function () {
        self.active = false;
    });


    if (Object.isType(options.header, Array)) {
        let res = "";
        options.header.forEach(function (h) {
            if (Object.isType(h, String)) {
                if ("=" === h || "-" === h || "*" === h)
                    res += str_util.fill(self.lineWidth, h) + os.EOL;
                else
                    res += self.formatLine(self.applySubst(h, self.substObj, 
                            self.lineWidth)) + os.EOL;
            }
        });
        self.file.write(res);
    }
}

// Overwrites the prototype so must be called before prototype functions are added.
util.inherits(Log, EventEmitter);

/**
 * Default log header. Log headers support the following substitution token:
 * 1) {{log.mode}} : Mode in which the log is being initialized (append, replace,
 *    unique, unique_pre)
 * 2) {{log.file}} : Name of the log file being used for logging.
 * 3) {{log.level}} : Maximum event level/type being logged (err, warn, info,trace).
 * 4) {{log.echo}} : on/off value indicating whether echo us enbled or not.
 * 5) {{date.now[,format]}} : String representing the current date and time. Optionally a
 *    formatting string
 * can be provided.
 * @type {String[]}
 */
Log.defHeader = [
    "=",
    "-Running log agent in '{{log.mode}}' mode-",
    "-Log file: {{log.fileName}}-",
    "-Initialized on {{date}}-",
    "="
];

/**
 * Default value when the 'echo' parameter is not provided.
 * @type {Boolean}
 */
Log.defEcho = true;

/**
 * Available modes for the Log object.
 * @readonly
 * @enum {number}
 */
Log.mode = {
    /** Append to the log file if it exists. */
    append: 0,
    /** Replace the log file if it exists */
    replace: 1,
    /** Create a new log file with a unique name */
    unique: 2,
    /** Create a new log file with a unique name with index being prefixed */
    unique_pre: 3
};

/**
 * Types of events /messages supported by the Log object. Which messages get actually
 * logged can be specified by setting the &lt;b>level&lt;/b> property to one of these values,
 * all event types presiding the value of &lt;b>level&lt;/b> are logged.
 * @readonly
 * @enum {number}
 */
Log.eventType = {
    // Simple text messages. The timestamp and event type indicator are not included
    text: -99,
    // Error message. A timestamp and error label (TypeLabel.err) are pre-pended to the
    // message
    err: -1,
    // Warning message. A timestamp and warning label (TypeLabel.warn) are pre-pended to
    // the message
    warn: 0,
    // Informational message. A timestamp and information label (TypeLabel.info) are
    // pre-pended to the message
    info: 1,
    // Trace message use when debugging the process. A timestamp and information label
    // (TypeLabel.info) are pre-pended to the message. Trace messages are omitted from the
    // log file by default, to enable then set the &lt;b>Log.prototype.level&lt;/b> to
    // &lt;b>Log.eventType.trace&lt;/b>.
    trace: 2
};

/**
 * Default labels used when creating new &lt;b>Log&lt;/b> instances or using the &lt;b>Log&lt;/b>
 * static methods without a global log instance. This static `property can be used to
 * change the event type labels of every new &lt;b>Log&lt;/b> instance that is creates. It is
 * generally recommended to change this property and not the instance property in order
 * to provide a consistent look between log files of the same application.
 * @type {{err: string, warn: string, info: string, trace: string}}
 */
Log.defTypeLabels = {
    err: "E",
    warn: "W",
    info: "I",
    trace: "T"
};

/**
 * Default format of the timestamp added to log messages, this value is assigned to new
 * instances of the &lt;b>Log&lt;/b> object. For information on the format used see the
 * Date.format documentation. This static `property can be used to change the time format
 * of every new &lt;b>Log&lt;/b> instance that is creates. It is generally recommended to
 * change this property and not the instance property in order to * provide a consistent
 * look between log files of the same application.
 * @type {string}
 */
Log.defTimeFormat = "yyyyMMdd HHmmss fff";

/**
 * Default value for log mode.
 * @type {Log.mode}
 */
Log.defMode = Log.mode.append;

/**
 * Default number of characters per line.
 * @type {Number}
 */
Log.defLineWidth = 100;

Log.modeStr = {};
Log.modeStr[Log.mode.append] = "append";
Log.modeStr[Log.mode.replace] = "replace";
Log.modeStr[Log.mode.unique] = "unique";
Log.modeStr[Log.mode.unique_pre] = "unique_pre";

Log.eventTypeStr = {};
Log.eventTypeStr[Log.eventType.text] = "text";
Log.eventTypeStr[Log.eventType.err] = "err";
Log.eventTypeStr[Log.eventType.warn] = "warn";
Log.eventTypeStr[Log.eventType.info] = "info";
Log.eventTypeStr[Log.eventType.trace] = "trace";

/**
 * Converts the given Log.mode to its string representation.
 * @param {Number} mode
 * @returns {String}
 */
Log.getModeStr = function (mode) {
    let ms = Log.modeStr[mode];
    if (!ms)
        return "Unknown Mode: " + mode;

    return ms;
};

/**
 * Converts the given Log.eventType to its string representation.
 * @param {Number} event_type
 * @returns {String}
 */
Log.getEvntTypeStr = function (event_type) {
    let ets = Log.eventTypeStr[event_type];
    if (!ets)
        return "Unknwon Event Type: " + event_type;

    return ets;
};

/**
 * Returns the Log.mode value from the given string.
 * @param {String} mode_str
 * @returns {Number}
 */
Log.modeFromStr = function (mode_str) {
    for (let key in Log.mode) {
        if (Log.mode.hasOwnProperty(key))
            if (key === mode_str)
                return Log.mode[key];
    }
    return Log.defMode;
};

/**
 * Returns the Log.eventType value from the given string.
 * @param {String} event_type_str
 * @returns {Number}
 */
Log.eventTypeFromStr = function (event_type_str) {
    for (let key in Log.eventType) {
        if (Log.eventType.hasOwnProperty(key))
            if (key === event_type_str)
                return Log.eventType[key];
    }
    return 999; // Unknown
};

/**
 * Returns the Log.eventType value from the given string.
 * @param {String} level_str
 * @returns {Number}
 */
Log.levelFromStr = function (level_str) {
    return Log.eventTypeFromStr(level_str);
};

/**
 * Builds a log file name with the given name and path. The methods adds the ".log"
 * extension if necessary. If using a unique mode, this function calls the
 * &lt;b>file.makeUnique&lt;/b> method to ensure the file name is unique, this method pre-pends
 * a two digit number starting from 00 and incrementing until a file with the same name
 * is not found &lt;b>makeLogFileName&lt;/b> ensures that the path leading to the log file
 * exists by calling &lt;b>path.ensure&lt;/b>.
 * @param {String} dir
 * Directory where log files are to be stored.
 * @param {string} name
 * Base name of the log file.
 * @returns {string} Returns the full name of the log file.
 */
Log.makeLogFileName = function (dir, name, mode) {
    let file_name = path.join(dir, name);
    if ("" === path.extname(file_name))
        file_name += ".log";

    if (Log.mode.unique === mode)
        file_name = file.makeUnique(file_name, false);
    else if (Log.mode.unique_pre === mode)
        file_name = file.makeUnique(file_name, true);

    file.ensurePath(path.dirname(file_name));
    return file_name;
};

/**
 * Sets the &lt;u>global log instance&lt;/u> to the given object. The &lt;b>Log&lt;/b> static methods
 * can then be used by any module that "requires" the &lt;b>Log&lt;/b> module.
 * @param {Log} log_instance Instance of &lt;b>Log&lt;/b> to be used as the
 * &lt;u>global log instance&lt;/u>.
 */
Log.setGlobal = function (log_instance) {
    global_log = log_instance;
};

/**
 * Outputs a message to the log file and/or standard output stream without timestamp or
 * message type indicators, the message is logged using the &lt;u>global log instance&lt;/u>.
 * @param {string} msg The message to send to the log file and/or console.
 * @param {LogCallback} [cb] Optional callback function. If provided, it will make the
 * call after the log entry is logged.
 * @param {...*} [subst] Optional list of substitution arguments.
 * When present, the method formats the message using either
 * {@link module:@crabel/shared/str_util~format str_util.format} or
 * {@link module:@crabel/shared/str_util~expand str_util.expand} depending on whether a
 * {@link module:@crabel/shared/str_util~substCallback substCallback} was provided.
 */
Log.out = function (msg, cb, subst) {
    _log.apply(null, _buildArgs(global_log || null, Log.eventType.text, arguments));
};

/**
 * Outputs an error message to the log file and/or standard output stream. The timestamp
 * and event type label are pre-pended to the given message. The timestamp can be
 * customized via the Log.timeFormat property; the event type label can be customized via
 * the 'Log.TypeLabel' property. The message is logged using the
 * &lt;u>global log instance&lt;/u>.
 * @param {String} msg The message to send to the log file and/or console.
 * @param {LogCallback} [cb] Optional callback function. If provided, it will make the call
 * after the log entry is logged.
 * @param {...*} [subst] Optional list of substitution arguments.
 * When present, the method formats the message using either
 * {@link module:@crabel/shared/str_util~format str_util.format} or
 * {@link module:@crabel/shared/str_util~expand str_util.expand} depending on whether a
 * {@link module:@crabel/shared/str_util~substCallback substCallback} was provided.
 */
Log.err = function (msg, cb, subst) {
    _log.apply(null, _buildArgs(global_log || null, Log.eventType.err, arguments));
};

/**
 * Outputs a warning message to the log file and/or standard output stream. The timestamp
 * and event type label are pre-pended to the given message. The timestamp can be
 * customized via the Log.timeFormat property; the event type label can be customized via
 * the 'Log.TypeLabel' property. The message is logged using the
 * &lt;u>global log instance&lt;/u>.
 * @param {string} msg The message to send to the log file and/or console.
 * @param {LogCallback} [cb] Optional callback function. If provided, it will make the
 * call after the log entry is logged.
 * @param {...*} [subst] Optional list of substitution arguments.
 * When present, the method formats the message using either
 * {@link module:@crabel/shared/str_util~format str_util.format} or
 * {@link module:@crabel/shared/str_util~expand str_util.expand} depending on whether a
 * {@link module:@crabel/shared/str_util~substCallback substCallback} was provided.
 */
Log.warn = function (msg, cb, subst) {
    _log.apply(null, _buildArgs(global_log || null, Log.eventType.warn, arguments));
};

/**
 * Outputs an informational message to the log file and/or standard output stream. The
 * timestamp and event type label are pre-pended to the given message. The timestamp can
 * be customized via the Log.timeFormat property; the event type label can be customized
 * via the 'Log.TypeLabel' property. The message is logged using the
 * &lt;u>global log instance&lt;/u>.
 * @param {string} msg The message to send to the log file and/or console.
 * @param {LogCallback} [cb] Optional callback function. If provided, it will make the
 * call after the log entry is logged.
 * @param {...*} [subst] Optional list of substitution arguments.
 * When present, the method formats the message using either
 * {@link module:@crabel/shared/str_util~format str_util.format} or
 * {@link module:@crabel/shared/str_util~expand str_util.expand} depending on whether a
 * {@link module:@crabel/shared/str_util~substCallback substCallback} was provided.
 */
Log.info = function (msg, cb, subst) {
    _log.apply(null, _buildArgs(global_log || null, Log.eventType.info, arguments));
};

/**
 * Outputs a trace message to the log file and/or standard output stream. The timestamp
 * and event type label are pre-pended to the given message. The timestamp can be
 * customized via the Log.timeFormat property; the event type label can be customized via
 * the 'Log.TypeLabel' property. The message is logged using the
 * &lt;u>global log instance&lt;/u>.
 * @param {string} msg The message to send to the log file and/or console.
 * @param {LogCallback} [cb] Optional callback function. If provided, it will make the
 * call after the log entry is logged.
 * @param {...*} [subst] Optional list of substitution arguments.
 * When present, the method formats the message using either
 * {@link module:@crabel/shared/str_util~format str_util.format} or
 * {@link module:@crabel/shared/str_util~expand str_util.expand} depending on whether a
 * {@link module:@crabel/shared/str_util~substCallback substCallback} was provided.
 */
Log.trace = function (msg, cb, subst) {
    _log.apply(null, _buildArgs(global_log || null, Log.eventType.trace, arguments));
};

// Instance Members

/**
 * Outputs a message to the log file and/or standard output stream without timestamp or
 * message type indicators.
 * @param {string} msg The message to send to the log file and/or console.
 * @param {LogCallback} [cb] Optional callback function. If provided, it will make the
 * call after the log entry is logged.
 * @param {...*} [subst] Optional list of substitution arguments.
 * When present, the method formats the message using either
 * {@link module:@crabel/shared/str_util~format str_util.format} or
 * {@link module:@crabel/shared/str_util~expand str_util.expand} depending on whether a
 * {@link module:@crabel/shared/str_util~substCallback substCallback} was provided.
 */
Log.prototype.out = function(msg, cb, subst) {
    _log.apply(null, _buildArgs(this, Log.eventType.text, arguments));
};

/**
 * Outputs an error message to the log file and/or standard output stream. The timestamp
 * and event type label are pre-pended to the given message. The timestamp can be
 * customized via the Log.timeFormat property; the event type label can be customized via
 * the 'Log.TypeLabel' property.
 * @param {string} msg The message to send to the log file and/or console.
 * @param {LogCallback} [cb] Optional callback function. If provided, it will make the
 * call after the log entry is logged.
 * @param {...*} [subst] Optional list of substitution arguments.
 * When present, the method formats the message using either
 * {@link module:@crabel/shared/str_util~format str_util.format} or
 * {@link module:@crabel/shared/str_util~expand str_util.expand} depending on whether a
 * {@link module:@crabel/shared/str_util~substCallback substCallback} was provided.
 */
Log.prototype.err = function (msg, cb, subst) {
    _log.apply(null, _buildArgs(this, Log.eventType.err, arguments));
};

/**
 * Outputs an informational message to the log file and/or standard output stream. The
 * timestamp and event type label are pre-pended to the given message. The timestamp can
 * be customized via the Log.timeFormat property; the event type label can be customized
 * via the 'Log.TypeLabel' property.
 * @param {string} msg The message to send to the log file and/or console.
 * @param {LogCallback} [cb] Optional callback function. If provided, it will make the
 * call after the log entry is logged.
 * @param {...*|callback} [subst] Optional list of substitution arguments or a
 * substitution function. When present, the method formats the message using either
 * {@link module:twt/str_util~format str_util.format} or
 * {@link module:twt/str_util~expand str_util.expand} depending on whether a
 * {@link module:twt/str_util~substCallback substCallback} was provided.
 */
Log.prototype.warn = function (msg, cb, subst) {
    _log.apply(null, _buildArgs(this, Log.eventType.warn, arguments));
};

/**
 * Outputs an informational message to the log file and/or standard output stream. The
 * timestamp and event type label are pre-pended to the given message. The timestamp can
 * be customized via the Log.timeFormat property; the event type label can be customized
 * via the 'Log.TypeLabel' property.
 * @param {string} msg The message to send to the log file and/or console.
 * @param {LogCallback} [cb] Optional callback function. If provided, it will make the
 * call after the log entry is logged.
 * @param {...*} [subst] Optional list of substitution arguments.
 * When present, the method formats the message using either
 * {@link module:twt/str_util~format str_util.format} or
 * {@link module:twt/str_util~expand str_util.expand} depending on whether a
 * {@link module:twt/str_util~substCallback substCallback} was provided.
 */
Log.prototype.info = function (msg, cb) {
    _log.apply(null, _buildArgs(this, Log.eventType.info, arguments));
};

/**
 * Outputs a trace message to the log file and/or standard output stream. The timestamp
 * and event type label are pre-pended to the given message. The timestamp can be
 * customized via the Log.timeFormat property; the event type label can be customized via
 * the 'Log.TypeLabel' property.
 * @param {string} msg The message to send to the log file and/or console.
 * @param {LogCallback} [cb] Optional callback function. If provided, it will make the
 * call after the log entry is logged.
 * @param {...*} [subst] Optional list of substitution arguments.
 * When present, the method formats the message using either
 * {@link module:twt/str_util~format str_util.format} or
 * {@link module:twt/str_util~expand str_util.expand} depending on whether a
 * {@link module:twt/str_util~substCallback substCallback} was provided.
 */
Log.prototype.trace = function (msg, cb) {
    _log.apply(null, _buildArgs(this, Log.eventType.trace, arguments));
};

/**
 * The &lt;b>shutdown&lt;b> function flushes and closes the log file rendering the log object
 * unusable. When done, the 'shutdown' event is emitted.
 * @param {Function} [cb]
 * @fires Log#shutdown
 */
Log.prototype.shutdown = function (cb) {
    let self = this;
    if (this.file) {
        this.file.end(function () {
            self.emit("shutdown");
            if (cb)
                cb();
        });

        // Set file to null right away to avoid another call to log to be sent while
        // closing the log file.
        this.file = null;
    }
    else {
        // Still need to invoke the callback to ensure the client has a chance to perform
        // further work if necessary.
        if (cb)
            setImmediate(function () { cb(); });
    }
};

/**
 * Substitutes any token in 'str" that matches either a property in 'this (log)" object
 * or in the given object. Date values are also replaced using the str_util.subst.date.
 * @param {String} str
 * @param {Date} [date]
 * @param {Object} [substObj]
 * @returns {String}
 */
Log.prototype.applySubst = function (str, date, substObj, width) {
    if (undefined !== date &amp;&amp; !Object.isType(date, Date)) {
        width = substObj;
        substObj = date;
        date = undefined;
    }

    let align = "left";
    if ("-" === str.charAt(0)) {
        str = str.substr(1);
        if ("-" === str.slice(-1)) {
            align = "center";
            str = str.substr(0, str.length - 1);
        }
        else
            align = "right";
    }

    str = str_util.subst.date(str, date || new Date());

    if (substObj)
        str = str_util.subst.prop(str, substObj);

    str = str_util.subst.prop(str, { log: this }, function (obj, prop_name) {
        if ("mode" === prop_name)
            return Log.modeStr[obj[prop_name]];
        if ("level" === prop_name)
            return log.eventTypeStr[obj[prop_name]];
    });

    return str_util.align(str, width, align);
};


// Events

/**
 * The &lt;b>busy&lt;/b> event is called whenever the Log object is busy.
 * @event Log#busy
 * @type {object}
 */

/**
 * The &lt;b>idle&lt;/b> event is called when the Log object is done processing events.
 * @event Log#idle
 * @type {object}
 */

/**
 * This event is emitted every time a a message is logged and includes the details of the
 * event.
 * @event Log#event
 * @param {string} fmsg Contains the formatted message that was recorded by the log
 * object.
 * @params {object} event Details of the event including the timestamp, type, original
 * message, etc.
 * @type {object}
 */

/**
 * This event is emitted after the Log object is completely shutdown.
 * @event Log#shutdown
 * @type {object}
 */


let last_log = null;

/**
 * Outputs a message to the logfile.
 * @param {Log} log
 * @param {String|Error} msg
 * @param {Number} type
 * @param {LogCallback} cb
 * @private
 */
function _log(log, msg, type, cb) {
    if(log &amp;&amp; !log.file) {
        let err = new Error("Failed to log message, the log has been shutdown.");
        if (cb)
            setImmediate(function () {
                cb(err);
            });
        else
            throw err;
    }

    if(undefined === msg)
        msg = "";

    if (Object.isType(msg, Error))
        msg = msg.message;

    if(4 &lt; arguments.length) {
        let args = Array.prototype.slice.call(arguments).slice(4, arguments.length);
        args.unshift(msg);
        if(Object.isType(args[1], Function))
            msg = str_util.expand.apply(null, args);
        else
            msg = str_util.format.apply(null, args);
    }

    let event = {
        timestamp: new Date(),
        type: type,
        message: (log) ? log.applySubst(msg, log.substObj) : msg,
        ignored: false
    };

    let fmsg;
    if(log) {
        if(0 === log.pendingEvents)
            log.emit("busy");
        ++log.pendingEvents;

        fmsg = getFormattedMessage(log.timeFormat, log.typeLabels);
        if (type > log.level) {
            event.ignored = true;

            if (cb)
                setImmediate(function () { cb(null, event, fmsg); });

            return;
        }

        if(log.echo) {
            if (last_log !== log) {
                if (last_log)
                    console.log();
                last_log = log;
                if (log &amp;&amp; log.caption)
                    console.log(log.caption);
                else
                    console.log("&lt;Anonimous>");
            }
            console.log(fmsg);
        }

        log.file.write(fmsg + os.EOL, function (err) {
            if (err) {
                err = new Error("Failed to write to log file.");
                log.emit("error", err, event, fmsg);
                if (cb)
                    cb(err);
                else
                    throw err;

                return;
            }

            log.emit("event", event, fmsg);
            log.pendingEvents--;
            if(0 === log.pendingEvents)
                log.emit("idle");

            if(cb)
                cb(null, event, fmsg);
        });
    }
    else {
        fmsg = getFormattedMessage(Log.defTimeFormat, Log.defTypeLabels);
        console.log(fmsg);

        if(cb)
            cb(null, event, fmsg);
    }

    function getFormattedMessage(time_format, type_labels) {
        if (!log)
            return event.message;
        
        if(Log.eventType.text === event.type)
            return log.formatLine(event.message);

        let type_width = 1 + Math.max(
            log.typeLabels.err.length,
            log.typeLabels.warn.length,
            log.typeLabels.info.length,
            log.typeLabels.trace.length
        );

        if("" === time_format) {
            return getTypeLabel(type_labels, type_width) 
                + log.formatLine(event.message, type_width);
        }

        let time_width = 1 + Date.formatLength(time_format);

        // Subtract the separation spaces when calculating the message width
        return event.timestamp.format(time_format) + " " +
            getTypeLabel(type_labels, type_width)  + log.formatLine(event.message,
                type_width + time_width);
    }

    function getTypeLabel(labels, type_width) {
        if(type === Log.eventType.err) return str_util.alignL(labels.err, type_width);
        if(type === Log.eventType.warn) return str_util.alignL(labels.warn, type_width);
        if(type == Log.eventType.info) return str_util.alignL(labels.info, type_width);
        if(type === Log.eventType.trace) return str_util.alignL(labels.trace, type_width);
        return str_util.alignL("", type_width);
    }
}

function _buildArgs(log, type, args) {
    if (0 == args.length)
        return [];

    let msg = args[0];
    let cb = null;
    let res;
    if (1 &lt; args.length &amp;&amp; Object.isType(args[1], Function)) {
        cb = args[1];
        res = Array.prototype.slice.call(args).slice(2, args.length);
    }
    else
        res = Array.prototype.slice.call(args).slice(1, args.length);
    res.unshift(cb);
    res.unshift(type);
    res.unshift(msg);
    res.unshift(log);

    return res;
}


module.exports = Log;</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="img/toast-ui.png" style="width: 0px; height: 0px">
    <div class="footer-text">Crabel Shared Library for JavaScript</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
